<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - StreetCats</title>

  <style>
    :root{
      --ink:#1f2937;
      --muted:#6b7280;
      --surface:#f8fafc;
      --line:#e5e7eb;
      --accent:#3b82f6;
    }
    * { box-sizing:border-box; }
    body{ 
      color:var(--ink); 
      font-family:system-ui, Arial, sans-serif;
      margin: 20px;
      background: #f9fafb;
    }

    .topbar{
      display:flex; align-items:center; justify-content:center;
      background:var(--surface);
      border:1px solid var(--line); border-radius:10px;
      padding:14px 16px; position:relative; margin-bottom:14px;
    }
    .topbar h1{ margin:0; font-weight:700; letter-spacing:.5px; }
    .topbar .home{
      position:absolute; right:12px; top:50%; transform:translateY(-50%);
      padding:8px 14px; border:1px solid var(--line); border-radius:8px;
      background:#fff; color:var(--ink); text-decoration:none;
    }
    .topbar .home:hover{ border-color:var(--accent); color:var(--accent); }

    .auth{
      max-width:420px; margin:0 auto; background:#fff;
      border:1px solid var(--line); border-radius:12px; padding:18px;
    }
    .fields{
      border:1px solid var(--line); border-radius:10px; padding:16px; margin-top:8px;
      background:#fff;
    }
    label{ display:block; margin:10px 0 6px; color:var(--muted); }
    input[type="email"], input[type="password"]{
      width:100%; padding:10px 12px; border:1px solid var(--line);
      border-radius:8px; background:#fff; color:var(--ink);
    }

    .btn{
      display:block; width:100%; margin:16px 0 6px;
      background:var(--accent); color:#fff; border:none;
      padding:10px 22px; border-radius:10px; cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.08);
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; }
    
    .link{
      background:none; border:none; padding:0; color:var(--accent);
      text-decoration:underline; cursor:pointer; font:inherit;
    }
    .link:hover{ color:#2563eb; }

    .hint{ text-align:center; margin-top:8px; color:var(--muted); }
    .message{ display:none; margin-top:10px; padding:10px; border-radius:8px; }
    .message-success{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .message-error{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  </style>
</head>
<body>

  <header class="topbar">
    <h1>Login</h1>
    <a class="home" href="index.html">Home</a>
  </header>

  <section class="auth">
    <!-- Messaggio -->
    <div id="message" class="message"></div>

    <!-- FORM LOGIN -->
    <div id="loginForm">
      <div class="fields">
        <form id="formLogin" novalidate>
          <label for="loginEmail">Email:</label>
          <input 
            id="loginEmail" 
            type="email" 
            autocomplete="email" 
            placeholder="tua@email.com"
            required 
          />

          <label for="loginPassword" style="margin-top:12px;">Password:</label>
          <input 
            id="loginPassword" 
            type="password" 
            autocomplete="current-password"
            placeholder="La tua password" 
            required 
          />

          <button id="btnLogin" class="btn" type="submit">Accedi</button>
        </form>
      </div>

      <p class="hint">
        Niente email? 
        <button id="btnShowRegister" class="link" type="button">Registrati</button>
      </p>
    </div>
  </section>

  <script>
    // ========================================
    // SCRIPT INLINE PER LOGIN.HTML
    // ========================================
    
    console.log('Pagina login caricata!');
    
    // Prendo gli elementi
    const formLogin = document.getElementById('formLogin');
    const inputEmail = document.getElementById('loginEmail');
    const inputPassword = document.getElementById('loginPassword');
    const bottoneLogin = document.getElementById('btnLogin');
    const bottoneRegistrati = document.getElementById('btnShowRegister');
    const elementoMessaggio = document.getElementById('message');
    
    
    // ========================================
    // 1. MOSTRA MESSAGGI
    // ========================================
    
    function mostraMessaggio(testo, tipo) {
      console.log('Messaggio:', testo);
      elementoMessaggio.style.display = 'block';
      elementoMessaggio.textContent = testo;
      elementoMessaggio.classList.remove('message-success', 'message-error');
      
      if (tipo === 'success') {
        elementoMessaggio.classList.add('message-success');
      } else {
        elementoMessaggio.classList.add('message-error');
      }
    }
    
    
    // ========================================
    // 2. VAI A REGISTRAZIONE
    // ========================================
    
    bottoneRegistrati.addEventListener('click', function() {
      console.log('Vado a registrazione.html');
      window.location.href = 'registrazione.html';
    });
    
    
    // ========================================
    // 3. VALIDAZIONE
    // ========================================
    
    function validaCampi(email, password) {
      console.log('Valido i campi...');
      
      if (!email || email.trim().length === 0) {
        mostraMessaggio('L\'email è obbligatoria!', 'error');
        return false;
      }
      
      const regexEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!regexEmail.test(email)) {
        mostraMessaggio('L\'email non è valida!', 'error');
        return false;
      }
      
      if (!password || password.length === 0) {
        mostraMessaggio('La password è obbligatoria!', 'error');
        return false;
      }
      
      if (password.length < 6) {
        mostraMessaggio('La password deve avere almeno 6 caratteri!', 'error');
        return false;
      }
      
      console.log('Campi validi!');
      return true;
    }
    
    
    // ========================================
    // 4. FUNZIONE LOGIN
    // ========================================
    
    async function effettuaLogin(email, password) {
      console.log('Effettuo login per:', email);
      
      try {
        const risposta = await fetch('http://localhost:3005/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: email,
            password: password
          })
        });
        
        console.log('Risposta ricevuta, status:', risposta.status);
        
        const dati = await risposta.json();
        console.log('Dati:', dati);
        
        if (risposta.ok) {
          // Successo ✅
          console.log('Login OK!');
          
          if (!dati.token) {
            mostraMessaggio('Errore: token mancante', 'error');
            return;
          }
          
          // Salvo nel localStorage
          localStorage.setItem('token', dati.token);
          localStorage.setItem('user', JSON.stringify(dati.user));
          console.log('Token salvato');
          
          mostraMessaggio('Login effettuato! Reindirizzamento...', 'success');
          
          // Vado alla homepage
          setTimeout(function() {
            window.location.href = 'index.html';
          }, 1000);
          
        } else {
          // Errore ❌
          console.log('Errore:', dati.error);
          mostraMessaggio(dati.error || 'Credenziali non valide', 'error');
        }
        
      } catch (errore) {
        console.error('Errore:', errore);
        mostraMessaggio('Errore di connessione al server. Riprova!', 'error');
      }
    }
    
    
    // ========================================
    // 5. GESTISCO IL FORM
    // ========================================
    
    formLogin.addEventListener('submit', function(evento) {
      evento.preventDefault();
      
      console.log('Form inviato!');
      
      const email = inputEmail.value.trim();
      const password = inputPassword.value;
      
      console.log('Email:', email);
      
      // Valido
      const valido = validaCampi(email, password);
      
      if (!valido) {
        return;
      }
      
      // Disabilito bottone
      bottoneLogin.disabled = true;
      bottoneLogin.textContent = 'Accesso in corso...';
      
      // Chiamo la funzione
      effettuaLogin(email, password)
        .finally(function() {
          bottoneLogin.disabled = false;
          bottoneLogin.textContent = 'Accedi';
        });
    });
    
    
    // ========================================
    // 6. CONTROLLO SE GIÀ LOGGATO
    // ========================================
    
    const token = localStorage.getItem('token');
    if (token) {
      console.log('Già loggato, vado alla home');
      window.location.href = 'index.html';
    }
  </script>

</body>
</html>