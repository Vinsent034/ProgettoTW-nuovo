<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>üß™ Test Backend StreetCats</title>
    <style>
        body { 
            font-family: monospace; 
            max-width: 900px; 
            margin: 30px auto; 
            background: #0f1115; 
            color: #e9e9e9; 
            padding: 20px;
        }
        h1 { color: #4f8cff; }
        .test { 
            background: #151821; 
            border: 1px solid #262a35; 
            border-radius: 8px; 
            padding: 15px; 
            margin: 15px 0; 
        }
        button { 
            background: #4f8cff; 
            color: #fff; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 6px; 
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #3b82f6; }
        .result { 
            margin-top: 10px; 
            padding: 10px; 
            background: #0f1115; 
            border-radius: 4px; 
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { border-left: 3px solid #16a34a; }
        .error { border-left: 3px solid #ef4444; }
        input { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            background: #0f1115; 
            border: 1px solid #262a35; 
            color: #e9e9e9; 
            border-radius: 4px;
        }
        label { display: block; margin-top: 10px; color: #a6a6a6; }
    </style>
</head>
<body>
    <h1>üß™ Test Backend StreetCats</h1>
    <p>Verifica che il backend sia funzionante su <code>http://localhost:3005</code></p>

    <!-- Test 1: Connessione -->
    <div class="test">
        <h3>1Ô∏è‚É£ Test Connessione Server</h3>
        <button onclick="testConnection()">üîå Testa Connessione</button>
        <div id="result1" class="result"></div>
    </div>

    <!-- Test 2: Registrazione -->
    <div class="test">
        <h3>2Ô∏è‚É£ Test Registrazione</h3>
        <label>Nome:</label>
        <input type="text" id="regName" value="Test User" />
        <label>Email:</label>
        <input type="email" id="regEmail" value="test@example.com" />
        <label>Password:</label>
        <input type="password" id="regPassword" value="password123" />
        <button onclick="testRegister()">üìù Registra Utente</button>
        <div id="result2" class="result"></div>
    </div>

    <!-- Test 3: Login -->
    <div class="test">
        <h3>3Ô∏è‚É£ Test Login</h3>
        <label>Email:</label>
        <input type="email" id="loginEmail" value="test@example.com" />
        <label>Password:</label>
        <input type="password" id="loginPassword" value="password123" />
        <button onclick="testLogin()">üîê Effettua Login</button>
        <div id="result3" class="result"></div>
    </div>

    <!-- Test 4: Lista Gatti -->
    <div class="test">
        <h3>4Ô∏è‚É£ Test Recupero Lista Gatti</h3>
        <button onclick="testGetCats()">üê± Carica Gatti</button>
        <div id="result4" class="result"></div>
    </div>

    <!-- Test 5: Aggiunta Gatto -->
    <div class="test">
        <h3>5Ô∏è‚É£ Test Aggiunta Gatto (richiede login)</h3>
        <p style="color: #a6a6a6; font-size: 13px;">
            Prima fai login (test 3), poi clicca qui sotto
        </p>
        <button onclick="testAddCat()">‚ûï Aggiungi Gatto di Test</button>
        <div id="result5" class="result"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:3005';
        let testToken = '';

        function log(id, message, isError = false) {
            const el = document.getElementById(id);
            el.textContent = message;
            el.className = 'result ' + (isError ? 'error' : 'success');
        }

        async function testConnection() {
            log('result1', '‚è≥ Connessione in corso...');
            try {
                const res = await fetch(`${API_URL}/`);
                const data = await res.json();
                log('result1', 
                    `‚úÖ Server raggiungibile!\n\n` +
                    `Status: ${res.status}\n` +
                    `Database: ${data.database}\n` +
                    `Timestamp: ${data.timestamp}\n\n` +
                    JSON.stringify(data, null, 2)
                );
            } catch (err) {
                log('result1', 
                    `‚ùå Errore di connessione!\n\n` +
                    `${err.message}\n\n` +
                    `Verifica che il backend sia avviato su http://localhost:3005`,
                    true
                );
            }
        }

        async function testRegister() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            log('result2', '‚è≥ Registrazione in corso...');
            
            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    log('result2', 
                        `‚úÖ Registrazione completata!\n\n` +
                        `User ID: ${data.userId}\n\n` +
                        JSON.stringify(data, null, 2)
                    );
                } else {
                    log('result2', 
                        `‚ö†Ô∏è Errore registrazione\n\n` +
                        `Status: ${res.status}\n` +
                        `Errore: ${data.error}\n\n` +
                        `(Potrebbe essere normale se l'email esiste gi√†)`,
                        true
                    );
                }
            } catch (err) {
                log('result2', `‚ùå Errore: ${err.message}`, true);
            }
        }

        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            log('result3', '‚è≥ Login in corso...');
            
            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    testToken = data.token;
                    log('result3', 
                        `‚úÖ Login effettuato!\n\n` +
                        `Token salvato per i test successivi\n\n` +
                        `User: ${data.user.name} (${data.user.email})\n` +
                        `Token: ${data.token.substring(0, 50)}...\n\n` +
                        JSON.stringify(data, null, 2)
                    );
                } else {
                    log('result3', 
                        `‚ùå Login fallito\n\n` +
                        `Status: ${res.status}\n` +
                        `Errore: ${data.error}`,
                        true
                    );
                }
            } catch (err) {
                log('result3', `‚ùå Errore: ${err.message}`, true);
            }
        }

        async function testGetCats() {
            log('result4', '‚è≥ Caricamento gatti...');
            
            try {
                const res = await fetch(`${API_URL}/cats`);
                const data = await res.json();
                
                log('result4', 
                    `‚úÖ Lista gatti ricevuta!\n\n` +
                    `Numero gatti: ${data.length}\n\n` +
                    JSON.stringify(data, null, 2)
                );
            } catch (err) {
                log('result4', `‚ùå Errore: ${err.message}`, true);
            }
        }

        async function testAddCat() {
            if (!testToken) {
                log('result5', 
                    `‚ùå Token mancante!\n\n` +
                    `Prima fai il login (Test 3) per ottenere un token.`,
                    true
                );
                return;
            }

            log('result5', '‚è≥ Creazione gatto di test...');

            // Crea un'immagine fake (pixel bianco 1x1)
            const blob = await fetch('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==')
                .then(r => r.blob());
            
            const formData = new FormData();
            formData.append('name', 'Gatto di Test ' + Date.now());
            formData.append('description', 'Questo √® un gatto di test aggiunto automaticamente per verificare il funzionamento del backend.');
            formData.append('lat', '40.8518');
            formData.append('lng', '14.2681');
            formData.append('image', blob, 'test.png');

            try {
                const res = await fetch(`${API_URL}/cats`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${testToken}`
                    },
                    body: formData
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    log('result5', 
                        `‚úÖ Gatto creato con successo!\n\n` +
                        `ID: ${data._id}\n` +
                        `Nome: ${data.name}\n` +
                        `Descrizione: ${data.description}\n` +
                        `Posizione: [${data.location.lat}, ${data.location.lng}]\n` +
                        `Immagine: ${data.image}\n\n` +
                        JSON.stringify(data, null, 2)
                    );
                } else {
                    log('result5', 
                        `‚ùå Errore creazione gatto\n\n` +
                        `Status: ${res.status}\n` +
                        `Errore: ${data.error}\n\n` +
                        JSON.stringify(data, null, 2),
                        true
                    );
                }
            } catch (err) {
                log('result5', `‚ùå Errore: ${err.message}`, true);
            }
        }

        // Auto-test connessione all'avvio
        window.addEventListener('load', () => {
            setTimeout(testConnection, 500);
        });
    </script>
</body>
</html>