<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dettaglio Gatto - StreetCats</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
        crossorigin="" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
      padding: 20px;
      color: #333;
    }

    /* Header */
    .header {
      max-width: 1200px;
      margin: 0 auto 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .back-link {
      color: #3b82f6;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 60px 20px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Error */
    .error-box {
      max-width: 600px;
      margin: 40px auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .error-box h2 {
      color: #ef4444;
      margin-bottom: 10px;
    }

    /* Container principale */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
      }
    }

    /* Card */
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .card h3 {
      margin-bottom: 15px;
      color: #333;
      font-size: 18px;
    }

    /* Immagine gatto */
    .cat-image {
      width: 100%;
      height: 400px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    /* Info gatto */
    .info-row {
      display: flex;
      gap: 10px;
      padding: 12px 0;
      border-bottom: 1px solid #e5e7eb;
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 500;
      color: #666;
      min-width: 100px;
    }

    .info-value {
      color: #333;
    }

    /* Descrizione */
    .description {
      line-height: 1.6;
      color: #333;
    }

    .description strong {
      font-weight: 600;
    }

    .description em {
      font-style: italic;
    }

    .description a {
      color: #3b82f6;
      text-decoration: underline;
    }

    /* Mappa */
    #map {
      width: 100%;
      height: 300px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
    }

    /* Sezione proprietario */
    .owner-section {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      border-radius: 8px;
      padding: 16px;
      margin-top: 20px;
    }

    .owner-section h4 {
      margin-bottom: 8px;
      color: #92400e;
    }

    .owner-section p {
      font-size: 14px;
      color: #78350f;
      margin-bottom: 12px;
    }

    .btn-delete {
      background: #ef4444;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .btn-delete:hover {
      background: #dc2626;
    }

    /* Sezione commenti */
    .comments-section {
      grid-column: 1 / -1;
    }

    .comment {
      background: #f9fafb;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 10px;
      position: relative;
    }

    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .comment-author {
      font-weight: 500;
      color: #333;
    }

    .comment-meta {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .comment-date {
      font-size: 12px;
      color: #666;
    }

    .comment-text {
      color: #333;
      line-height: 1.5;
    }

    .comment-form {
      margin-top: 20px;
    }

    .comment-form textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      resize: vertical;
      min-height: 80px;
      font-family: inherit;
    }

    .comment-form button {
      margin-top: 10px;
      background: #3b82f6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }

    .comment-form button:hover {
      background: #2563eb;
    }

    .comment-form button:disabled {
      background: #93c5fd;
      cursor: not-allowed;
    }

    .no-comments {
      text-align: center;
      color: #666;
      padding: 20px;
      font-style: italic;
    }

    /* Badge */
    .badge {
      display: inline-block;
      background: #dbeafe;
      color: #1e40af;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    /* Pulsante elimina commento */
    .btn-delete-comment {
      background: none;
      border: none;
      color: #ef4444;
      cursor: pointer;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .btn-delete-comment:hover {
      background: #fee2e2;
    }
  </style>
</head>
<body>

  <!-- Header -->
  <div class="header">
    <h1>üê± Dettaglio Gatto</h1>
    <a href="index.html" class="back-link">‚Üê Torna alla mappa</a>
  </div>

  <!-- Loading -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <p>Caricamento dettagli gatto...</p>
  </div>

  <!-- Error -->
  <div id="errorBox" class="error-box" style="display:none;">
    <h2>üòø Gatto non trovato</h2>
    <p id="errorMessage">Il gatto che stai cercando non esiste o √® stato rimosso.</p>
    <a href="index.html" class="back-link" style="display:inline-block; margin-top:20px;">
      Torna alla mappa
    </a>
  </div>

  <!-- Contenuto principale -->
  <div id="content" class="container" style="display:none;">
    
    <!-- Colonna sinistra -->
    <div>
      <!-- Foto gatto -->
      <div class="card">
        <img id="catImage" class="cat-image" alt="Foto del gatto" />
      </div>

      <!-- Info gatto -->
      <div class="card" style="margin-top:20px;">
        <h3>üìã Informazioni</h3>
        
        <div class="info-row">
          <span class="info-label">Nome:</span>
          <span class="info-value" id="catName">-</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">Avvistato il:</span>
          <span class="info-value" id="catDate">-</span>
        </div>
        
        <div class="info-row">
          <span class="info-label">Segnalato da:</span>
          <span class="info-value" id="catAuthor">-</span>
        </div>
      </div>

      <!-- Sezione proprietario -->
      <div id="ownerSection" class="owner-section" style="display:none;">
        <h4>‚ö†Ô∏è Sei il proprietario di questo post</h4>
        <p>Puoi eliminare questo gatto dalla mappa se necessario</p>
        <button class="btn-delete" onclick="deletePost()">
          üóëÔ∏è Elimina Pubblicazione
        </button>
      </div>
    </div>

    <!-- Colonna destra -->
    <div>
      <!-- Descrizione -->
      <div class="card">
        <h3>üìù Descrizione</h3>
        <div id="catDescription" class="description">-</div>
      </div>

      <!-- Mappa -->
      <div class="card" style="margin-top:20px;">
        <h3>üìç Posizione dell'Avvistamento</h3>
        <div id="map"></div>
      </div>
    </div>

    <!-- Commenti (full width) -->
    <div class="card comments-section">
      <h3>üí¨ Commenti (<span id="commentCount">0</span>)</h3>
      
      <div id="commentsList"></div>

      <!-- Form nuovo commento (solo se loggato) -->
      <div id="commentFormSection" style="display:none;">
        <div class="comment-form">
          <textarea 
            id="commentText" 
            placeholder="Scrivi un commento..."
            maxlength="500"
          ></textarea>
          <button id="btnAddComment" onclick="addComment()">Aggiungi Commento</button>
        </div>
      </div>

      <div id="loginPrompt" style="display:none; text-align:center; padding:20px; color:#666;">
        <a href="login.html" style="color:#3b82f6;">Effettua il login</a> per lasciare un commento
      </div>
    </div>

  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
          crossorigin=""></script>

  <!-- Config -->
  <script>
    window.CONFIG = { API_URL: 'http://localhost:3005' };
  </script>

  <!-- Script principale -->
  <script>
    let map;
    let catData;
    let catId;
    let currentUser = null;

    // ========== UTILITY ==========
    function show(el) { if (el) el.style.display = ''; }
    function hide(el) { if (el) el.style.display = 'none'; }

    // ========== GET CAT ID FROM URL ==========
    function getCatIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      console.log('üÜî Cat ID:', id);
      return id;
    }

    // ========== FORMATTA DESCRIZIONE (Markdown-like) ==========
    function formatDescription(text) {
      if (!text) return '-';
      
      return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g, '<br>')
        .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    }

    // ========== FORMATTA DATA ==========
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('it-IT', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ========== ESCAPE HTML ==========
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========== CARICA DETTAGLI GATTO ==========
    async function loadCatDetails() {
      console.log('üì• Caricamento dettagli...');

      try {
        const url = `${window.CONFIG.API_URL}/cats/${catId}`;
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error('Gatto non trovato');
        }

        catData = await response.json();
        console.log('‚úÖ Dati ricevuti:', catData);

        displayCatDetails();
        checkOwnership();
        initMap();
        loadComments();

        hide(document.getElementById('loading'));
        show(document.getElementById('content'));

      } catch (error) {
        console.error('‚ùå Errore:', error);
        document.getElementById('errorMessage').textContent = error.message;
        hide(document.getElementById('loading'));
        show(document.getElementById('errorBox'));
      }
    }

    // ========== MOSTRA DETTAGLI ==========
    function displayCatDetails() {
      // Immagine
      const imgEl = document.getElementById('catImage');
      imgEl.src = `${window.CONFIG.API_URL}/uploads/${catData.image}`;
      imgEl.onerror = function() {
        this.src = 'https://via.placeholder.com/400x300?text=Immagine+non+disponibile';
      };

      // Nome
      document.getElementById('catName').textContent = catData.name;

      // Data
      document.getElementById('catDate').textContent = formatDate(catData.date);

      // Autore
      let authorName = 'Utente anonimo';
      if (catData.author) {
        if (typeof catData.author === 'object') {
          authorName = catData.author.name || catData.author.email || 'Utente';
        }
      }
      document.getElementById('catAuthor').textContent = authorName;

      // Descrizione
      document.getElementById('catDescription').innerHTML = formatDescription(catData.description);
    }

    // ========== INIZIALIZZA MAPPA ==========
    function initMap() {
      console.log('üó∫Ô∏è Inizializzo mappa...');

      try {
        const lat = catData.location.lat;
        const lng = catData.location.lng;

        map = L.map('map').setView([lat, lng], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '¬© OpenStreetMap'
        }).addTo(map);

        L.marker([lat, lng])
          .addTo(map)
          .bindPopup(`üê± ${catData.name} avvistato qui`)
          .openPopup();

        console.log('‚úÖ Mappa caricata');

      } catch (error) {
        console.error('‚ùå Errore mappa:', error);
        document.getElementById('map').innerHTML = 
          '<p style="padding:20px;text-align:center;color:#666;">Errore caricamento mappa</p>';
      }
    }

    // ========== CONTROLLA PROPRIETARIO ==========
    function checkOwnership() {
      const userStr = localStorage.getItem('user');
      if (!userStr) {
        console.log('üë§ Utente non loggato');
        return;
      }

      currentUser = JSON.parse(userStr);
      console.log('üë§ User ID:', currentUser.id);

      let authorId;
      if (catData.author) {
        if (typeof catData.author === 'object') {
          authorId = catData.author._id || catData.author.id;
        } else {
          authorId = catData.author;
        }
      }
      console.log('‚úçÔ∏è Author ID:', authorId);

      if (currentUser.id && authorId && 
          currentUser.id.toString() === authorId.toString()) {
        console.log('‚úÖ Sono il proprietario');
        show(document.getElementById('ownerSection'));
      }
    }

    // ========== ELIMINA GATTO ==========
    async function deletePost() {
      const confirmMsg = `Sei sicuro di voler eliminare "${catData.name}"?\n\nQuesta azione √® irreversibile!`;
      
      if (!confirm(confirmMsg)) return;

      console.log('üóëÔ∏è Eliminazione in corso...');

      const token = localStorage.getItem('token');
      if (!token) {
        alert('Sessione scaduta. Effettua nuovamente il login.');
        window.location.href = 'login.html';
        return;
      }

      try {
        const url = `${window.CONFIG.API_URL}/cats/${catId}`;
        const response = await fetch(url, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (response.ok) {
          alert('‚úÖ Gatto eliminato con successo!');
          window.location.href = 'index.html';
        } else {
          throw new Error(data.error || 'Errore durante l\'eliminazione');
        }

      } catch (error) {
        console.error('‚ùå Errore:', error);
        alert('‚ùå ' + error.message);
      }
    }

    // ========== CARICA COMMENTI ==========
    async function loadComments() {
      console.log('üí¨ Caricamento commenti...');

      try {
        const url = `${window.CONFIG.API_URL}/comments/${catId}`;
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error('Errore caricamento commenti');
        }

        const comments = await response.json();
        console.log('‚úÖ Commenti ricevuti:', comments.length);

        displayComments(comments);

        // Mostra form solo se loggato
        if (localStorage.getItem('token')) {
          show(document.getElementById('commentFormSection'));
        } else {
          show(document.getElementById('loginPrompt'));
        }

      } catch (error) {
        console.error('‚ùå Errore commenti:', error);
        document.getElementById('commentsList').innerHTML = 
          '<p class="no-comments">Impossibile caricare i commenti</p>';
      }
    }

    // ========== MOSTRA COMMENTI ==========
    function displayComments(comments) {
      const container = document.getElementById('commentsList');
      document.getElementById('commentCount').textContent = comments.length;

      if (comments.length === 0) {
        container.innerHTML = '<p class="no-comments">Nessun commento ancora. Sii il primo!</p>';
        return;
      }

      container.innerHTML = comments.map(comment => {
        const isOwner = currentUser && comment.author?._id === currentUser.id;
        
        return `
          <div class="comment">
            <div class="comment-header">
              <span class="comment-author">
                ${escapeHtml(comment.author?.name || 'Utente')}
                ${isOwner ? '<span class="badge">Tu</span>' : ''}
              </span>
              <div class="comment-meta">
                <span class="comment-date">${formatDate(comment.date)}</span>
                ${isOwner ? `<button class="btn-delete-comment" onclick="deleteComment('${comment._id}')">üóëÔ∏è Elimina</button>` : ''}
              </div>
            </div>
            <div class="comment-text">${escapeHtml(comment.text)}</div>
          </div>
        `;
      }).join('');
    }

    // ========== AGGIUNGI COMMENTO ==========
    async function addComment() {
      const textarea = document.getElementById('commentText');
      const btn = document.getElementById('btnAddComment');
      const text = textarea.value.trim();

      if (!text) {
        alert('Scrivi qualcosa nel commento!');
        return;
      }

      if (text.length < 1) {
        alert('Il commento √® troppo corto!');
        return;
      }

      const token = localStorage.getItem('token');
      if (!token) {
        alert('Devi effettuare il login per commentare!');
        window.location.href = 'login.html';
        return;
      }

      console.log('üí¨ Invio commento...');
      btn.disabled = true;
      btn.textContent = 'Invio...';

      try {
        const url = `${window.CONFIG.API_URL}/comments/${catId}`;
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ text })
        });

        if (!response.ok) {
          const data = await response.json();
          throw new Error(data.error || 'Errore durante l\'invio');
        }

        console.log('‚úÖ Commento aggiunto');
        textarea.value = '';
        loadComments();

      } catch (error) {
        console.error('‚ùå Errore:', error);
        alert('‚ùå ' + error.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Aggiungi Commento';
      }
    }

    // ========== ELIMINA COMMENTO ==========
    async function deleteComment(commentId) {
      if (!confirm('Sei sicuro di voler eliminare questo commento?')) {
        return;
      }

      console.log('üóëÔ∏è Eliminazione commento:', commentId);

      const token = localStorage.getItem('token');
      if (!token) {
        alert('Sessione scaduta. Effettua nuovamente il login.');
        window.location.href = 'login.html';
        return;
      }

      try {
        const url = `${window.CONFIG.API_URL}/comments/${commentId}`;
        const response = await fetch(url, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });

        const data = await response.json();

        if (response.ok) {
          console.log('‚úÖ Commento eliminato');
          loadComments();
        } else {
          throw new Error(data.error || 'Errore durante l\'eliminazione');
        }

      } catch (error) {
        console.error('‚ùå Errore:', error);
        alert('‚ùå ' + error.message);
      }
    }

    // ========== INIZIALIZZAZIONE ==========
    window.addEventListener('DOMContentLoaded', function() {
      console.log('üì± Pagina cat-detail caricata');

      catId = getCatIdFromUrl();

      if (!catId) {
        console.error('‚ùå ID mancante');
        document.getElementById('errorMessage').textContent = 
          'ID del gatto mancante nell\'URL';
        hide(document.getElementById('loading'));
        show(document.getElementById('errorBox'));
        return;
      }

      loadCatDetails();
    });
  </script>

</body>
</html>