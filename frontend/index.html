<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>StreetCats - Home</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>StreetCats</h1>
      <nav class="header-nav" id="nav">
        <span>Caricamento...</span>
      </nav>
    </div>
  </header>

  <!-- Contenuto principale -->
  <main class="container">
    <div class="card">
      <h2>Mappa dei Gatti</h2>
      <div id="map"></div>
    </div>

    <div id="loading" class="loading">Caricamento gatti in corso...</div>
    
    <div id="message" class="card" style="display: none;">
      <!-- Messaggi dinamici -->
    </div>
  </main>

  <!-- Script -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="js/config.js"></script>
  <script src="js/auth.js"></script>
  <script src="js/utils.js"></script>
  <script>
    // Variabili globali
    let map;
    let gatti = [];

    // Inizializza la pagina
    window.addEventListener('DOMContentLoaded', function() {
      console.log('Pagina caricata');
      aggiornaNavbar();
      inizializzaMappa();
      caricaGatti();
    });

    // Aggiorna la navbar in base allo stato di login
    function aggiornaNavbar() {
      const nav = document.getElementById('nav');
      
      if (isLoggato()) {
        const utente = getUtente();
        nav.innerHTML = '<span style="margin-right: 15px;">Ciao, ' + utente.name + '</span>' +
                       '<a href="add-cat.html">Aggiungi Gatto</a>' +
                       '<a href="#" onclick="logout(); return false;">Logout</a>';
      } else {
        nav.innerHTML = '<a href="login.html">Login</a>';
      }
    }

    // Inizializza la mappa Leaflet
    function inizializzaMappa() {
      console.log('Inizializzo mappa...');
      
      // Crea la mappa centrata su Napoli
      map = L.map('map').setView([40.8518, 14.2681], 12);
      
      // Aggiungi il layer delle tile di OpenStreetMap
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);
      
      console.log('Mappa inizializzata');
    }

    // Carica i gatti dal server
    async function caricaGatti() {
      console.log('Caricamento gatti da:', CONFIG.API_URL + '/cats');
      
      try {
        const response = await fetch(CONFIG.API_URL + '/cats');
        
        if (!response.ok) {
          throw new Error('Errore HTTP: ' + response.status);
        }
        
        gatti = await response.json();
        console.log('Gatti ricevuti:', gatti.length);
        
        document.getElementById('loading').style.display = 'none';
        
        if (gatti.length === 0) {
          const messageDiv = document.getElementById('message');
          messageDiv.innerHTML = '<p>Nessun gatto segnalato. Registrati e aggiungi il primo gatto!</p>';
          messageDiv.style.display = 'block';
        } else {
          mostraGattiSullaMappa();
        }
      } catch (error) {
        console.error('Errore nel caricamento:', error);
        document.getElementById('loading').innerHTML = 
          '<p style="color: red;">Errore: impossibile connettersi al server.</p>' +
          '<p>Assicurati che il backend sia avviato su http://localhost:3005</p>';
      }
    }

    // Mostra i gatti sulla mappa
    function mostraGattiSullaMappa() {
      console.log('Mostro gatti sulla mappa');
      
      gatti.forEach(function(gatto) {
        const marker = L.marker([gatto.location.lat, gatto.location.lng]).addTo(map);
        
        const popupContent = '<div style="text-align: center; min-width: 150px;">' +
                            '<strong>' + gatto.name + '</strong><br>' +
                            '<small>' + formattaData(gatto.date) + '</small><br><br>' +
                            '<a href="cat-detail.html?id=' + gatto._id + '" style="color: #2c3e50;">Vedi dettagli</a>' +
                            '</div>';
        
        marker.bindPopup(popupContent);
      });
      
      // Centra la mappa su tutti i marker
      if (gatti.length > 0) {
        const bounds = L.latLngBounds(gatti.map(function(g) {
          return [g.location.lat, g.location.lng];
        }));
        map.fitBounds(bounds, { padding: [50, 50] });
      }
    }
  </script>
</body>
</html>