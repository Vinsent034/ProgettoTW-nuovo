<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aggiungi Gatto - StreetCats</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    * { box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f2f2f2; padding: 16px; margin: 0; }

    .container { max-width: 640px; margin: 0 auto; background: #fff; border: 1px solid #ccc; padding: 16px; }
    h1 { font-size: 22px; margin: 0 0 10px; }
    .subtitle { color: #555; font-size: 14px; margin-bottom: 18px; }

    .back-link { display: inline-block; margin-bottom: 12px; color: #1a73e8; text-decoration: none; }
    .back-link:hover { text-decoration: underline; }

    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; font-weight: bold; font-size: 14px; }
    input[type="text"], textarea, input[type="file"] {
      width: 100%; border: 1px solid #bbb; padding: 8px; font-size: 14px; }
    textarea { min-height: 90px; resize: vertical; }
    .hint { margin-top: 4px; font-size: 12px; color: #777; }

    #map { width: 100%; height: 320px; border: 1px solid #bbb; background: #f7f7f7; margin-top: 6px; }

    .preview img { max-width: 100%; margin-top: 8px; border: 1px solid #bbb; }

    .buttons { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    button { border: 1px solid #000; padding: 8px 12px; background: #ddd; cursor: pointer; }
    .btn-cancel { background: #e9e9e9; }
    .btn-submit { background: #1a73e8; color: #fff; border-color: #1a73e8; }
    .btn-submit:disabled { background: #9bbcf4; border-color: #9bbcf4; cursor: not-allowed; }

    .message { display:none; margin-top: 10px; padding: 10px; border: 1px solid transparent; font-size: 14px; }
    .message.success { display:block; background:#e6f4ea; color:#0b5; border-color:#b7e1c1; }
    .message.error { display:block; background:#fde7e9; color:#b00020; border-color:#f5c2c7; }

    .error-field { border-color: #e53935 !important; }
  </style>
</head>
<body>

  <div class="container">
    <a href="index.html" class="back-link">‚Üê Torna alla mappa</a>

    <h1>Aggiungi Gatto</h1>
    <p class="subtitle">Segnala un gatto avvistato nella tua zona</p>

    <form id="addCatForm" enctype="multipart/form-data">
      <div class="form-group">
        <label for="name">Nome del gatto *</label>
        <input type="text" id="name" name="name" placeholder="es. Micio, Felix, Gatto rosso..." required minlength="2" />
        <div class="hint">Minimo 2 caratteri</div>
      </div>

      <div class="form-group">
        <label for="description">Descrizione *</label>
        <textarea id="description" name="description" placeholder="Descrivi il gatto: colore, comportamento, dove lo hai visto..." required minlength="10"></textarea>
        <div class="hint">Minimo 10 caratteri</div>
      </div>

      <div class="form-group">
        <label>Posizione sulla mappa *</label>
        <div id="map"></div>
        <div class="hint">Clicca sulla mappa per selezionare la posizione</div>
      </div>

      <input type="hidden" id="lat" name="lat" />
      <input type="hidden" id="lng" name="lng" />

      <div class="form-group">
        <label for="image">Foto del gatto *</label>
        <input type="file" id="image" name="image" accept="image/*" required />
        <div class="hint">Max 5MB</div>
        <div id="imagePreview" class="preview"></div>
      </div>

      <div id="formMsg" class="message"></div>

      <div class="buttons">
        <button type="button" class="btn-cancel" id="cancelBtn">Annulla</button>
        <button type="submit" class="btn-submit" id="submitBtn">Pubblica Gatto</button>
      </div>
    </form>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script> window.CONFIG = { API_URL: 'http://localhost:3005' }; </script>
  <script>
    let map, marker, selectedLat = null, selectedLng = null;
    const form = document.getElementById('addCatForm');
    const msg = document.getElementById('formMsg');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const imageInput = document.getElementById('image');
    const imagePreview = document.getElementById('imagePreview');
    const latInput = document.getElementById('lat');
    const lngInput = document.getElementById('lng');

    function showMessage(text, type) {
      msg.textContent = text;
      msg.className = 'message ' + type;
      msg.style.display = 'block';
    }
    function hideMessage() { msg.style.display = 'none'; }
    function setLoading(loading) {
      submitBtn.disabled = loading;
      submitBtn.textContent = loading ? 'Caricamento...' : 'Pubblica Gatto';
    }

    function initMap() {
      try {
        map = L.map('map').setView([40.8518, 14.2681], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        map.on('click', function (e) {
          selectedLat = e.latlng.lat;
          selectedLng = e.latlng.lng;
          latInput.value = selectedLat;
          lngInput.value = selectedLng;
          if (marker) map.removeLayer(marker);
          marker = L.marker([selectedLat, selectedLng]).addTo(map);
          marker.bindPopup('Gatto qui').openPopup();
          document.getElementById('map').style.borderColor = '#bbb';
        });
      } catch (err) {
        document.getElementById('map').innerHTML = '<p style="padding:20px;text-align:center;color:red;">Errore caricamento mappa</p>';
      }
    }

    imageInput.addEventListener('change', function () {
      imagePreview.innerHTML = '';
      if (this.files && this.files[0]) {
        const file = this.files[0];
        if (file.size > 5 * 1024 * 1024) {
          showMessage('Immagine troppo grande (max 5MB)', 'error');
          this.value = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = function (e) {
          const img = document.createElement('img');
          img.src = e.target.result;
          imagePreview.appendChild(img);
        };
        reader.readAsDataURL(file);
      }
    });

    cancelBtn.addEventListener('click', function () {
      if (confirm('Vuoi annullare? Perderai tutti i dati.')) {
        window.location.href = 'index.html';
      }
    });

    form.addEventListener('submit', async function (e) {
      e.preventDefault();
      hideMessage();
      const name = form.name.value.trim();
      const description = form.description.value.trim();
      const file = imageInput.files[0];

      if (name.length < 2) {
        form.name.classList.add('error-field');
        showMessage('Il nome deve avere almeno 2 caratteri', 'error');
        return;
      }
      form.name.classList.remove('error-field');
      if (description.length < 10) {
        form.description.classList.add('error-field');
        showMessage('La descrizione deve avere almeno 10 caratteri', 'error');
        return;
      }
      form.description.classList.remove('error-field');
      if (!selectedLat || !selectedLng) {
        document.getElementById('map').style.borderColor = '#e53935';
        showMessage('Clicca sulla mappa per selezionare la posizione', 'error');
        return;
      }
      if (!file) {
        imageInput.classList.add('error-field');
        showMessage('Carica una foto del gatto', 'error');
        return;
      }
      imageInput.classList.remove('error-field');
      const token = localStorage.getItem('token');
      if (!token) {
        showMessage('Devi fare il login per pubblicare', 'error');
        setTimeout(() => { window.location.href = 'login.html'; }, 1500);
        return;
      }
      const formData = new FormData();
      formData.append('name', name);
      formData.append('description', description);
      formData.append('lat', selectedLat);
      formData.append('lng', selectedLng);
      formData.append('image', file);
      setLoading(true);
      try {
        const url = `${window.CONFIG.API_URL}/cats`;
        const response = await fetch(url, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: formData });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Errore salvataggio');
        showMessage('Gatto pubblicato! Reindirizzamento...', 'success');
        setTimeout(() => { window.location.href = 'index.html'; }, 1500);
      } catch (err) {
        showMessage(err.message, 'error');
      } finally {
        setLoading(false);
      }
    });

    window.addEventListener('DOMContentLoaded', function () {
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Devi fare il login!');
        window.location.href = 'login.html';
        return;
      }
      initMap();
    });
  </script>
</body>
</html>