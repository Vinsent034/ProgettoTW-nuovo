<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registrazione Gatto - StreetCats</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root{
      --ink:#1f2937; --muted:#6b7280; --surface:#f8fafc;
      --line:#e5e7eb; --accent:#3b82f6;
    }
    *{ box-sizing:border-box; }
    body{ margin:20px; font-family:system-ui, Arial, sans-serif; color:var(--ink); background:#f9fafb; }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      background:var(--surface); border:1px solid var(--line); border-radius:10px;
      padding:14px 16px; margin-bottom:14px;
    }
    .topbar h1{ margin:0; font-weight:700; letter-spacing:.5px; }
    .topbar .back{
      padding:8px 14px; border:1px solid var(--line); border-radius:8px;
      background:#fff; color:var(--ink); text-decoration:none;
    }
    .topbar .back:hover{ border-color:var(--accent); color:var(--accent); }

    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 18px;
    }
    
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr; }
    }

    .panel{
      background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px;
    }

    .dropzone{
      border:2px dashed var(--line); border-radius:10px; padding:14px;
      min-height: 240px; display:flex; align-items:center; justify-content:center;
      text-align:center; color:var(--muted); position:relative;
    }
    .dropzone input{ display:block; margin-top:8px; }
    .dropzone.has-image{ border-color:var(--accent); }
    
    .image-preview{
      max-width:100%; max-height:220px; border-radius:8px; display:none;
    }
    .image-preview.show{ display:block; }

    .field label{ display:block; margin:10px 0 6px; color:var(--muted); }
    .field input[type="text"],
    .field textarea{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:8px; background:#fff;
    }
    .field textarea{ min-height:120px; resize:vertical; }

    #map{ height:260px; border:1px solid var(--line); border-radius:10px; }
    
    .location-info{
      margin-top:8px; padding:8px; background:var(--surface); border-radius:6px;
      font-size:0.9em; display:none;
    }
    .location-info.show{ display:block; }

    .actions{ display:flex; justify-content:center; gap:10px; margin:22px 0 8px; }
    .btn{
      background:var(--accent); color:#fff; border:none; padding:10px 22px;
      border-radius:10px; cursor:pointer; box-shadow:0 1px 0 rgba(0,0,0,.08);
    }
    .btn:hover{ filter:brightness(1.05); }
    .btn:disabled{ opacity:0.6; cursor:not-allowed; }
    .btn-secondary{
      background:#fff; color:var(--ink); border:1px solid var(--line);
    }
    
    .hint{ color:var(--muted); font-size:.9rem; }
    
    .message{
      display:none; margin-bottom:14px; padding:10px; border-radius:8px;
    }
    .message.show{ display:block; }
    .message-success{ background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
    .message-error{ background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  </style>
</head>
<body>

  <header class="topbar">
    <h1>üê± Aggiungi Gatto</h1>
    <a class="back" href="index.html">‚Üê Torna alla mappa</a>
  </header>

  <!-- Messaggio -->
  <div id="message" class="message"></div>

  <form id="formAddCat" class="grid" enctype="multipart/form-data">
    <!-- Colonna sinistra -->
    <div>
      <div class="panel">
        <h3 style="margin:0 0 10px 0;">üì∑ Foto del gatto</h3>
        <div class="dropzone" id="dropzone">
          <div id="dropzoneContent">
            <div>Trascina una foto qui oppure scegli un file</div>
            <input id="catImage" name="image" type="file" accept="image/*" required />
            <div class="hint" style="margin-top:8px;">PNG/JPG, max 5MB</div>
          </div>
          <img id="imagePreview" class="image-preview" alt="Anteprima" />
        </div>
      </div>

      <div class="panel" style="margin-top:18px;">
        <h3 style="margin:0 0 10px 0;">üìç Posizione del gatto</h3>
        <div id="map"></div>
        <div class="hint" style="margin-top:6px;">Clicca sulla mappa per impostare la posizione.</div>
        
        <div id="locationInfo" class="location-info">
          <strong>Posizione selezionata:</strong><br>
          Lat: <span id="latDisplay">-</span>, Lng: <span id="lngDisplay">-</span>
        </div>

        <!-- Campi nascosti -->
        <input type="hidden" id="lat" name="lat" />
        <input type="hidden" id="lng" name="lng" />
      </div>
    </div>

    <!-- Colonna destra -->
    <div>
      <div class="panel">
        <div class="field">
          <label for="catName">Nome del gatto *</label>
          <input id="catName" name="name" type="text" placeholder="Es. Micio, Fufi, Felix..." required />
        </div>

        <div class="field">
          <label for="catDescription">Descrizione *</label>
          <textarea id="catDescription" name="description" placeholder="Descrivi il gatto: colore, comportamento, caratteristiche particolari..." required></textarea>
          <div class="hint">Minimo 10 caratteri</div>
        </div>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-secondary" onclick="window.location.href='index.html'">
          Annulla
        </button>
        <button id="btnPublish" class="btn" type="submit">
          Pubblica Gatto
        </button>
      </div>
    </div>
  </form>

  <script>
    // ========================================
    // SCRIPT INLINE PER REGISTRAZIONE GATTO
    // ========================================
    
    console.log('Pagina registrazione gatto caricata!');
    
    let map;
    let pickMarker = null;
    
    // Elementi DOM
    const formAddCat = document.getElementById('formAddCat');
    const inputImage = document.getElementById('catImage');
    const inputName = document.getElementById('catName');
    const inputDescription = document.getElementById('catDescription');
    const inputLat = document.getElementById('lat');
    const inputLng = document.getElementById('lng');
    const btnPublish = document.getElementById('btnPublish');
    const messageEl = document.getElementById('message');
    const imagePreview = document.getElementById('imagePreview');
    const dropzone = document.getElementById('dropzone');
    const dropzoneContent = document.getElementById('dropzoneContent');
    const locationInfo = document.getElementById('locationInfo');
    const latDisplay = document.getElementById('latDisplay');
    const lngDisplay = document.getElementById('lngDisplay');
    
    
    // ========================================
    // 1. CONTROLLO AUTENTICAZIONE
    // ========================================
    
    function checkAuth() {
      const token = localStorage.getItem('token');
      
      if (!token) {
        console.log('Utente non loggato! Reindirizzo...');
        alert('Devi essere loggato per aggiungere un gatto!');
        window.location.href = 'login.html';
        return false;
      }
      
      console.log('Utente loggato, token presente');
      return true;
    }
    
    // Controllo subito
    if (!checkAuth()) {
      // Blocco il resto dello script
      throw new Error('Non autenticato');
    }
    
    
    // ========================================
    // 2. INIZIALIZZA MAPPA
    // ========================================
    
    document.addEventListener('DOMContentLoaded', () => {
      try {
        map = L.map('map', { scrollWheelZoom: true })
          .setView([40.8518, 14.2681], 12);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        console.log('Mappa inizializzata');
        
        // Click sulla mappa
        map.on('click', function(e) {
          const { lat, lng } = e.latlng;
          
          console.log('Posizione selezionata:', lat, lng);
          
          // Aggiorno i campi hidden
          inputLat.value = lat.toFixed(6);
          inputLng.value = lng.toFixed(6);
          
          // Aggiorno il display
          latDisplay.textContent = lat.toFixed(6);
          lngDisplay.textContent = lng.toFixed(6);
          locationInfo.classList.add('show');
          
          // Aggiungo/sposto il marker
          if (pickMarker) {
            pickMarker.setLatLng(e.latlng);
          } else {
            pickMarker = L.marker(e.latlng).addTo(map);
            pickMarker.bindPopup('üìç Posizione del gatto').openPopup();
          }
        });
        
      } catch(e) {
        console.error('Errore mappa:', e);
        document.getElementById('map').innerHTML =
          '<p style="padding:12px;color:#b00020;">Impossibile caricare la mappa.</p>';
      }
    });
    
    
    // ========================================
    // 3. PREVIEW IMMAGINE
    // ========================================
    
    inputImage.addEventListener('change', function(e) {
      const file = e.target.files[0];
      
      if (!file) return;
      
      console.log('Immagine selezionata:', file.name, file.size);
      
      // Controllo dimensione (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        mostraMessaggio('Immagine troppo grande! Max 5MB', 'error');
        inputImage.value = '';
        return;
      }
      
      // Controllo tipo
      if (!file.type.startsWith('image/')) {
        mostraMessaggio('Devi selezionare un\'immagine!', 'error');
        inputImage.value = '';
        return;
      }
      
      // Mostro preview
      const reader = new FileReader();
      reader.onload = function(e) {
        imagePreview.src = e.target.result;
        imagePreview.classList.add('show');
        dropzoneContent.style.display = 'none';
        dropzone.classList.add('has-image');
      };
      reader.readAsDataURL(file);
    });
    
    
    // ========================================
    // 4. MOSTRA MESSAGGI
    // ========================================
    
    function mostraMessaggio(testo, tipo) {
      console.log('Messaggio:', testo);
      messageEl.textContent = testo;
      messageEl.className = 'message show message-' + tipo;
      messageEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    function nascondiMessaggio() {
      messageEl.className = 'message';
    }
    
    
    // ========================================
    // 5. VALIDAZIONE
    // ========================================
    
    function validaForm() {
      console.log('Valido il form...');
      
      // Nome
      const name = inputName.value.trim();
      if (!name || name.length < 2) {
        mostraMessaggio('Il nome deve avere almeno 2 caratteri!', 'error');
        return false;
      }
      
      // Descrizione
      const description = inputDescription.value.trim();
      if (!description || description.length < 10) {
        mostraMessaggio('La descrizione deve avere almeno 10 caratteri!', 'error');
        return false;
      }
      
      // Immagine
      if (!inputImage.files || !inputImage.files[0]) {
        mostraMessaggio('Devi selezionare una foto!', 'error');
        return false;
      }
      
      // Posizione
      const lat = inputLat.value;
      const lng = inputLng.value;
      if (!lat || !lng) {
        mostraMessaggio('Devi selezionare la posizione sulla mappa!', 'error');
        return false;
      }
      
      console.log('Validazione OK!');
      return true;
    }
    
    
    // ========================================
    // 6. INVIO FORM
    // ========================================
    
    formAddCat.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      console.log('Form inviato!');
      nascondiMessaggio();
      
      // Valido
      if (!validaForm()) {
        return;
      }
      
      // Prendo i dati
      const name = inputName.value.trim();
      const description = inputDescription.value.trim();
      const lat = inputLat.value;
      const lng = inputLng.value;
      const image = inputImage.files[0];
      
      console.log('Dati:', { name, description, lat, lng, image: image.name });
      
      // Creo FormData
      const formData = new FormData();
      formData.append('name', name);
      formData.append('description', description);
      formData.append('lat', lat);
      formData.append('lng', lng);
      formData.append('image', image);
      
      // Prendo il token
      const token = localStorage.getItem('token');
      if (!token) {
        mostraMessaggio('Token mancante! Rifare il login', 'error');
        setTimeout(() => window.location.href = 'login.html', 2000);
        return;
      }
      
      // Disabilito il bottone
      btnPublish.disabled = true;
      btnPublish.textContent = 'Caricamento...';
      
      try {
        console.log('Invio richiesta al server...');
        
        const risposta = await fetch('http://localhost:3005/cats', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
            // NON mettere Content-Type con FormData!
          },
          body: formData
        });
        
        console.log('Risposta ricevuta, status:', risposta.status);
        
        const dati = await risposta.json();
        console.log('Dati:', dati);
        
        if (risposta.ok) {
          // Successo! ‚úÖ
          console.log('Gatto aggiunto con successo!');
          mostraMessaggio('Gatto pubblicato con successo! üéâ', 'success');
          
          // Vado alla homepage dopo 2 secondi
          setTimeout(() => {
            window.location.href = 'index.html';
          }, 2000);
          
        } else {
          // Errore ‚ùå
          console.log('Errore dal server:', dati);
          mostraMessaggio(dati.error || dati.message || 'Errore durante il caricamento', 'error');
          
          btnPublish.disabled = false;
          btnPublish.textContent = 'Pubblica Gatto';
        }
        
      } catch (errore) {
        console.error('Errore:', errore);
        mostraMessaggio('Errore di connessione al server!', 'error');
        
        btnPublish.disabled = false;
        btnPublish.textContent = 'Pubblica Gatto';
      }
    });
    
    
    console.log('Script pronto!');
  </script>

</body>
</html>